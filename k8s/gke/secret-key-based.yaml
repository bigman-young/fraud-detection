# Alternative: Service Account Key-based authentication
# Use this if Workload Identity is not available
# 
# To create the secret:
#   kubectl create secret generic gcp-credentials \
#     --from-file=key.json=/path/to/service-account-key.json \
#     -n fraud-detection

apiVersion: v1
kind: Secret
metadata:
  name: gcp-credentials
  namespace: fraud
  labels:
    app: transaction-producer
type: Opaque
# The actual key.json content will be created via kubectl command
# data:
#   key.json: <base64-encoded-service-account-key>
---
# Deployment using Secret for authentication
apiVersion: apps/v1
kind: Deployment
metadata:
  name: transaction-producer-with-key
  namespace: fraud
  labels:
    app: transaction-producer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: transaction-producer
  template:
    metadata:
      labels:
        app: transaction-producer
    spec:
      containers:
        - name: producer
          image: gcr.io/hsbc-484505/transaction-producer:latest
          imagePullPolicy: Always
          env:
            - name: GOOGLE_CLOUD_PROJECT
              value: "hsbc-484505"
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: "/var/secrets/google/key.json"
          envFrom:
            - configMapRef:
                name: producer-config
          volumeMounts:
            - name: gcp-credentials
              mountPath: /var/secrets/google
              readOnly: true
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: gcp-credentials
          secret:
            secretName: gcp-credentials
      restartPolicy: Always
