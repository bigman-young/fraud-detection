<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FraudDetectionJob.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Real-Time Fraud Detection System</a> &gt; <a href="index.source.html" class="el_package">com.hsbc.fraud</a> &gt; <span class="el_source">FraudDetectionJob.java</span></div><h1>FraudDetectionJob.java</h1><pre class="source lang-java linenums">package com.hsbc.fraud;

import com.hsbc.fraud.model.FraudAlert;
import com.hsbc.fraud.model.Transaction;
import com.hsbc.fraud.processor.FraudDetectionProcessor;
import com.hsbc.fraud.processor.VelocityCheckProcessor;
import com.hsbc.fraud.sink.AlertSink;
import com.hsbc.fraud.source.TransactionSource;
import com.hsbc.fraud.source.TransactionSource.SourceType;
import org.apache.flink.api.common.eventtime.WatermarkStrategy;
import org.apache.flink.streaming.api.datastream.DataStream;
import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.streaming.api.functions.sink.SinkFunction;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Duration;

/**
 * Main Flink job for real-time fraud detection.
 * This job processes transaction streams and generates fraud alerts in real-time.
 * 
 * Supported data sources (configured via SOURCE_TYPE environment variable):
 * - PUBSUB: Google Cloud Pub/Sub (default)
 * - KAFKA: Apache Kafka
 * - DEMO: Simulated data for testing
 */
<span class="nc" id="L29">public class FraudDetectionJob {</span>

<span class="nc" id="L31">    private static final Logger LOG = LoggerFactory.getLogger(FraudDetectionJob.class);</span>

    // Default configuration values
    private static final String DEFAULT_SOURCE_TYPE = &quot;PUBSUB&quot;;
    private static final String DEFAULT_GCP_PROJECT = &quot;hsbc-484505&quot;;
    private static final String DEFAULT_PUBSUB_SUBSCRIPTION = &quot;transactions-sub&quot;;
    private static final String DEFAULT_KAFKA_SERVERS = &quot;10.113.192.45:9092&quot;;
    private static final String DEFAULT_INPUT_TOPIC = &quot;transactions&quot;;
    private static final String DEFAULT_ALERT_TOPIC = &quot;fraud-alerts&quot;;
    private static final String DEFAULT_ALERT_THRESHOLD = &quot;0.4&quot;;

    public static void main(String[] args) throws Exception {
<span class="nc" id="L43">        LOG.info(&quot;Starting Fraud Detection Job...&quot;);</span>

        // Get source type configuration
<span class="nc" id="L46">        String sourceTypeStr = getEnvOrDefault(&quot;SOURCE_TYPE&quot;, DEFAULT_SOURCE_TYPE);</span>
        SourceType sourceType;
        try {
<span class="nc" id="L49">            sourceType = SourceType.valueOf(sourceTypeStr.toUpperCase());</span>
<span class="nc" id="L50">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L51">            LOG.warn(&quot;Invalid SOURCE_TYPE '{}', defaulting to PUBSUB&quot;, sourceTypeStr);</span>
<span class="nc" id="L52">            sourceType = SourceType.PUBSUB;</span>
<span class="nc" id="L53">        }</span>

        // Get common configuration
<span class="nc" id="L56">        double alertThreshold = Double.parseDouble(getEnvOrDefault(&quot;ALERT_THRESHOLD&quot;, DEFAULT_ALERT_THRESHOLD));</span>

        // Create execution environment
<span class="nc" id="L59">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span>

        // Configure environment
<span class="nc" id="L62">        configureEnvironment(env);</span>

        // Build and execute the pipeline based on source type
<span class="nc" id="L65">        FraudDetectionJob job = new FraudDetectionJob();</span>

<span class="nc" id="L67">        LOG.info(&quot;Using source type: {}&quot;, sourceType);</span>

<span class="nc bnc" id="L69" title="All 3 branches missed.">        switch (sourceType) {</span>
            case PUBSUB:
<span class="nc" id="L71">                String gcpProject = getEnvOrDefault(&quot;GOOGLE_CLOUD_PROJECT&quot;, DEFAULT_GCP_PROJECT);</span>
<span class="nc" id="L72">                String subscription = getEnvOrDefault(&quot;PUBSUB_SUBSCRIPTION&quot;, DEFAULT_PUBSUB_SUBSCRIPTION);</span>
<span class="nc" id="L73">                String alertTopic = getEnvOrDefault(&quot;PUBSUB_ALERT_TOPIC&quot;, &quot;fraud-alerts&quot;);</span>
<span class="nc" id="L74">                job.buildPubSubPipeline(env, gcpProject, subscription, alertTopic, alertThreshold);</span>
<span class="nc" id="L75">                break;</span>

            case KAFKA:
<span class="nc" id="L78">                String kafkaServers = getEnvOrDefault(&quot;KAFKA_BOOTSTRAP_SERVERS&quot;, DEFAULT_KAFKA_SERVERS);</span>
<span class="nc" id="L79">                String inputTopic = getEnvOrDefault(&quot;INPUT_TOPIC&quot;, DEFAULT_INPUT_TOPIC);</span>
<span class="nc" id="L80">                String kafkaAlertTopic = getEnvOrDefault(&quot;ALERT_TOPIC&quot;, DEFAULT_ALERT_TOPIC);</span>
<span class="nc" id="L81">                job.buildKafkaPipeline(env, kafkaServers, inputTopic, kafkaAlertTopic, alertThreshold);</span>
<span class="nc" id="L82">                break;</span>

            case DEMO:
            default:
<span class="nc" id="L86">                job.buildDemoPipeline(env, alertThreshold);</span>
                break;
        }

        // Execute
<span class="nc" id="L91">        env.execute(&quot;Real-Time Fraud Detection System&quot;);</span>
<span class="nc" id="L92">    }</span>

    /**
     * Configures the Flink execution environment.
     */
    private static void configureEnvironment(StreamExecutionEnvironment env) {
        // Enable checkpointing for fault tolerance
<span class="nc" id="L99">        env.enableCheckpointing(60000); // Checkpoint every 60 seconds</span>
        
        // Set parallelism based on environment
<span class="nc" id="L102">        int parallelism = Integer.parseInt(getEnvOrDefault(&quot;PARALLELISM&quot;, &quot;1&quot;));</span>
<span class="nc" id="L103">        env.setParallelism(parallelism);</span>

<span class="nc" id="L105">        LOG.info(&quot;Environment configured with parallelism: {}&quot;, parallelism);</span>
<span class="nc" id="L106">    }</span>

    /**
     * Builds the fraud detection pipeline with Google Cloud Pub/Sub source.
     * This is the default pipeline configuration.
     */
    public void buildPubSubPipeline(StreamExecutionEnvironment env,
                                     String projectId,
                                     String subscriptionId,
                                     String alertTopic,
                                     double alertThreshold) {

<span class="nc" id="L118">        LOG.info(&quot;Building Pub/Sub pipeline: project={}, subscription={}, alertTopic={}&quot;,</span>
                projectId, subscriptionId, alertTopic);

        // Create Pub/Sub source
<span class="nc" id="L122">        DataStream&lt;Transaction&gt; transactions = TransactionSource.createPubSubSource(</span>
                env, projectId, subscriptionId);

        // Process transactions
<span class="nc" id="L126">        DataStream&lt;FraudAlert&gt; alerts = processTransactions(transactions, alertThreshold);</span>

        // Output alerts to Pub/Sub
<span class="nc" id="L129">        alerts.addSink(new AlertSink.PubSubSink(projectId, alertTopic))</span>
<span class="nc" id="L130">              .name(&quot;Pub/Sub Alert Sink&quot;);</span>
        
        // Output alerts to log (Pub/Sub sink can be added later if needed)
<span class="nc" id="L133">        alerts.addSink(new AlertSink.LoggingSink())</span>
<span class="nc" id="L134">              .name(&quot;Logging Sink&quot;);</span>

        // Print to console for monitoring
<span class="nc" id="L137">        alerts.print().name(&quot;Console Output&quot;);</span>
<span class="nc" id="L138">    }</span>

    /**
     * Builds the fraud detection pipeline with Kafka source and sink.
     */
    public void buildKafkaPipeline(StreamExecutionEnvironment env, 
                                    String bootstrapServers,
                                    String inputTopic, 
                                    String alertTopic,
                                    double alertThreshold) {

<span class="nc" id="L149">        LOG.info(&quot;Building Kafka pipeline: input={}, alerts={}&quot;, inputTopic, alertTopic);</span>

        // Create Kafka source
<span class="nc" id="L152">        DataStream&lt;Transaction&gt; transactions = TransactionSource.createKafkaSource(</span>
                env, bootstrapServers, inputTopic);

        // Process transactions
<span class="nc" id="L156">        DataStream&lt;FraudAlert&gt; alerts = processTransactions(transactions, alertThreshold);</span>

        // Output to Kafka
<span class="nc" id="L159">        alerts.sinkTo(AlertSink.createKafkaSink(bootstrapServers, alertTopic))</span>
<span class="nc" id="L160">              .name(&quot;Kafka Alert Sink&quot;);</span>

        // Also log to console for monitoring
<span class="nc" id="L163">        alerts.addSink(new AlertSink.LoggingSink())</span>
<span class="nc" id="L164">              .name(&quot;Logging Sink&quot;);</span>
<span class="nc" id="L165">    }</span>

    /**
     * Builds a demo pipeline with generated transaction data.
     */
    public void buildDemoPipeline(StreamExecutionEnvironment env, double alertThreshold) {
<span class="nc" id="L171">        LOG.info(&quot;Building demo pipeline with simulated transactions&quot;);</span>

        // Create demo source that generates random transactions
<span class="nc" id="L174">        DataStream&lt;Transaction&gt; transactions = env</span>
<span class="nc" id="L175">                .addSource(new TransactionSource.DemoTransactionSource())</span>
<span class="nc" id="L176">                .name(&quot;Demo Transaction Source&quot;);</span>

        // Add watermarks for event time processing
<span class="nc" id="L179">        transactions = transactions</span>
<span class="nc" id="L180">                .assignTimestampsAndWatermarks(</span>
<span class="nc" id="L181">                        WatermarkStrategy.&lt;Transaction&gt;forBoundedOutOfOrderness(Duration.ofSeconds(5))</span>
<span class="nc" id="L182">                                .withTimestampAssigner((tx, timestamp) -&gt; </span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                                        tx.getTimestamp() != null ? tx.getTimestamp().toEpochMilli() : System.currentTimeMillis())</span>
                );

        // Process transactions
<span class="nc" id="L187">        DataStream&lt;FraudAlert&gt; alerts = processTransactions(transactions, alertThreshold);</span>

        // Output alerts to log
<span class="nc" id="L190">        alerts.addSink(new AlertSink.LoggingSink())</span>
<span class="nc" id="L191">              .name(&quot;Logging Sink&quot;);</span>

        // Print to console
<span class="nc" id="L194">        alerts.print().name(&quot;Console Output&quot;);</span>
<span class="nc" id="L195">    }</span>

    /**
     * Processes transactions through the fraud detection pipeline.
     * This is the core processing logic shared by all pipeline configurations.
     */
    public DataStream&lt;FraudAlert&gt; processTransactions(DataStream&lt;Transaction&gt; transactions, 
                                                       double alertThreshold) {
        // Rule-based fraud detection
<span class="nc" id="L204">        SingleOutputStreamOperator&lt;FraudAlert&gt; ruleBasedAlerts = transactions</span>
<span class="nc" id="L205">                .flatMap(new FraudDetectionProcessor(alertThreshold))</span>
<span class="nc" id="L206">                .name(&quot;Rule-Based Fraud Detection&quot;);</span>

        // Velocity-based fraud detection (stateful)
<span class="nc" id="L209">        SingleOutputStreamOperator&lt;FraudAlert&gt; velocityAlerts = transactions</span>
<span class="nc" id="L210">                .keyBy(Transaction::getAccountId)</span>
<span class="nc" id="L211">                .process(new VelocityCheckProcessor())</span>
<span class="nc" id="L212">                .name(&quot;Velocity Check&quot;);</span>

        // Union all alert streams
<span class="nc" id="L215">        return ruleBasedAlerts.union(velocityAlerts);</span>
    }

    /**
     * Gets environment variable or returns default value.
     */
    private static String getEnvOrDefault(String name, String defaultValue) {
<span class="nc" id="L222">        String value = System.getenv(name);</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">        return value != null &amp;&amp; !value.isEmpty() ? value : defaultValue;</span>
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>