# GitHub Actions workflow for deploying Flink Fraud Detection Job to GKE
#
# This workflow builds and deploys the Flink-based fraud detection job
# that reads from Google Cloud Pub/Sub (default), Kafka, or demo source.
#
# Required GitHub Secrets:
#   - GCP_PROJECT_ID: hsbc-484505
#   - GCP_SA_KEY: Service account key JSON (base64 encoded)
#   - GKE_CLUSTER: hsbc-cluster-1
#   - GKE_REGION: asia-east1
#
# Optional Secrets:
#   - SOURCE_TYPE: PUBSUB (default), KAFKA, or DEMO

name: Build and Deploy Flink Job to GKE

on:
  # push:
  #   branches:
  #     - main
  #     - master
  #   paths:
  #     - 'src/main/java/com/hsbc/fraud/**'
  #     - 'pom.xml'
  #     - 'Dockerfile.flink-job'
  #     - 'k8s/gke/flink-job-*.yaml'
  #     - '.github/workflows/deploy-flink-job.yml'
  # pull_request:
  #   branches:
  #     - main
  #     - master
  workflow_dispatch: # Allow manual trigger
    inputs:
      source_type:
        description: "Data source type (PUBSUB, KAFKA, DEMO)"
        required: false
        default: "PUBSUB"
        type: choice
        options:
          - PUBSUB
          - KAFKA
          - DEMO

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  IMAGE_NAME: fraud-detection-job
  DEPLOYMENT_NAME: fraud-detection-job
  NAMESPACE: fraud
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: fraud-repo

jobs:
  # Job 1: Build and Test
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests -B

      - name: Run Tests
        run: mvn test -B

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-job-jar
          path: target/fraud-detection-system-*.jar
          retention-days: 1

  # Job 2: Build and Push Docker Image
  docker:
    name: Build Docker Image
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      image_tag: ${{ steps.image.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-job-jar
          path: target/

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Set image tag
        id: image
        run: |
          echo "tag=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build and Push Docker image
        run: |
          IMAGE=${{ steps.image.outputs.tag }}
          docker build -f Dockerfile.flink-job -t $IMAGE .
          docker tag $IMAGE ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

  # Job 3: Deploy to GKE
  deploy:
    name: Deploy to GKE
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: "gke-gcloud-auth-plugin"

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.PROJECT_ID }}

      - name: Set source type from input
        id: config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.source_type }}" ]; then
            echo "source_type=${{ github.event.inputs.source_type }}" >> $GITHUB_OUTPUT
          else
            echo "source_type=PUBSUB" >> $GITHUB_OUTPUT
          fi

      - name: Update ConfigMap with source type
        run: |
          # Update SOURCE_TYPE in configmap if manually triggered with different source
          sed -i "s/SOURCE_TYPE: \"PUBSUB\"/SOURCE_TYPE: \"${{ steps.config.outputs.source_type }}\"/g" k8s/gke/flink-job-configmap.yaml

      - name: Update image reference in deployment
        run: |
          # Update image to use Artifact Registry with specific SHA
          sed -i "s|gcr.io/hsbc-484505/fraud-detection-job:latest|${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" k8s/gke/flink-job-deployment.yaml

      - name: Verify GCP Service Account for Workload Identity
        run: |
          # NOTE: Service account should be pre-created manually
          # Run once: gcloud iam service-accounts create fraud-detection --display-name="Fraud Detection Service Account"

          SA_NAME="fraud-detection"
          SA_EMAIL="${SA_NAME}@${{ env.PROJECT_ID }}.iam.gserviceaccount.com"

          echo "Verifying service account exists: ${SA_EMAIL}"
          if gcloud iam service-accounts describe ${SA_EMAIL} --project ${{ env.PROJECT_ID }} &>/dev/null; then
            echo "✓ Service account ${SA_EMAIL} exists"
          else
            echo "✗ Service account ${SA_EMAIL} not found!"
            echo ""
            echo "Please create it manually with:"
            echo "  gcloud iam service-accounts create fraud-detection --display-name='Fraud Detection Service Account' --project ${{ env.PROJECT_ID }}"
            echo "  gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} --member='serviceAccount:${SA_EMAIL}' --role='roles/pubsub.subscriber'"
            exit 1
          fi

      - name: Deploy to GKE
        run: |
          # Create namespace if not exists
          kubectl apply -f k8s/gke/namespace.yaml

          # Apply Flink Job configurations
          kubectl apply -f k8s/gke/flink-job-configmap.yaml
          kubectl apply -f k8s/gke/flink-job-deployment.yaml

          # Force rollout to ensure new image is used
          kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s

      - name: Get deployment status
        run: |
          echo "============================================="
          echo "  Flink Job Deployment Status"
          echo "============================================="
          echo ""
          echo "=== Deployment ==="
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.DEPLOYMENT_NAME }}
          echo ""
          echo "=== ConfigMap ==="
          kubectl get configmap flink-job-config -n ${{ env.NAMESPACE }} -o yaml | grep -A 20 "data:"
          echo ""
          echo "=== Recent Logs ==="
          kubectl logs deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }} --tail=20 || true

      - name: Deployment Summary
        run: |
          echo ""
          echo "============================================="
          echo "  Deployment Complete!"
          echo "============================================="
          echo ""
          echo "Image: ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Source Type: ${{ steps.config.outputs.source_type }}"
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo ""
          echo "Commands to monitor:"
          echo "  kubectl logs -f deployment/${{ env.DEPLOYMENT_NAME }} -n ${{ env.NAMESPACE }}"
          echo "  kubectl get pods -n ${{ env.NAMESPACE }} -w"
