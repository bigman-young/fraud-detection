# GitHub Actions workflow for deploying Flink Cluster to GKE
#
# This workflow deploys a complete Flink cluster:
#   - JobManager (1 replica)
#   - TaskManager (2+ replicas with HPA)
#   - Submits the Fraud Detection Job
#
# Required GitHub Secrets:
#   - GCP_PROJECT_ID: hsbc-484505
#   - GCP_SA_KEY: Service account key JSON (base64 encoded)
#
# Flink Cluster Configuration (hardcoded, different from Producer cluster):
#   - Cluster: flink-cluster
#   - Region: asia-east1-a

name: Deploy Flink Cluster to GKE

on:
  #push:
    # branches:
    #   - main
    #   - master
    # paths:
    #   - "src/main/java/com/hsbc/fraud/**"
    #   - "pom.xml"
    #   - "Dockerfile.flink-cluster"
    #   - "k8s/gke/flink/**"
    #   - ".github/workflows/deploy-flink-cluster.yml"
  workflow_dispatch:
    inputs:
      taskmanager_replicas:
        description: "Number of TaskManager replicas"
        required: false
        default: "1"
        type: string
      source_type:
        description: "Data source type (PUBSUB, KAFKA, DEMO)"
        required: false
        default: "PUBSUB"
        type: choice
        options:
          - PUBSUB
          - KAFKA
          - DEMO
      deploy_cluster_only:
        description: "Deploy cluster without submitting job"
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  # Flink cluster uses dedicated cluster (different from Producer)
  GKE_CLUSTER: flink-cluster
  GKE_REGION: asia-east1-a
  IMAGE_NAME: flink-fraud-detection
  NAMESPACE: fraud
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: fraud-repo

jobs:
  # Job 1: Build and Test
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests -B

      - name: Run Tests
        run: mvn test -B

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-job-jar
          path: target/fraud-detection-system-*.jar
          retention-days: 1

  # Job 2: Build and Push Custom Flink Image
  docker:
    name: Build Flink Image
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-job-jar
          path: target/

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Build and Push Flink image
        run: |
          IMAGE=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker build -f Dockerfile.flink-cluster -t $IMAGE .
          docker tag $IMAGE ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          docker push $IMAGE
          docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

  # Job 3: Deploy Flink Cluster to GKE
  deploy-cluster:
    name: Deploy Flink Cluster
    needs: docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: "gke-gcloud-auth-plugin"

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.PROJECT_ID }}

      - name: Verify GCP Service Account for Flink
        run: |
          # NOTE: Service accounts should be pre-created manually with proper permissions
          # Run these commands once in GCP Console or with an admin account:
          #
          # gcloud iam service-accounts create flink-cluster --display-name="Flink Cluster Service Account"
          # gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:flink-cluster@$PROJECT_ID.iam.gserviceaccount.com" --role="roles/pubsub.subscriber"
          # gcloud iam service-accounts add-iam-policy-binding flink-cluster@$PROJECT_ID.iam.gserviceaccount.com --role="roles/iam.workloadIdentityUser" --member="serviceAccount:$PROJECT_ID.svc.id.goog[fraud/flink-sa]"

          SA_NAME="flink-cluster"
          SA_EMAIL="${SA_NAME}@${{ env.PROJECT_ID }}.iam.gserviceaccount.com"

          echo "Verifying service account exists: ${SA_EMAIL}"
          if gcloud iam service-accounts describe ${SA_EMAIL} --project ${{ env.PROJECT_ID }} &>/dev/null; then
            echo "✓ Service account ${SA_EMAIL} exists"
          else
            echo "✗ Service account ${SA_EMAIL} not found!"
            echo ""
            echo "Please create it manually with:"
            echo "  gcloud iam service-accounts create flink-cluster --display-name='Flink Cluster Service Account' --project ${{ env.PROJECT_ID }}"
            exit 1
          fi

      - name: Set configuration
        id: config
        run: |
          # TaskManager replicas
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.taskmanager_replicas }}" ]; then
            echo "tm_replicas=${{ github.event.inputs.taskmanager_replicas }}" >> $GITHUB_OUTPUT
          else
            echo "tm_replicas=2" >> $GITHUB_OUTPUT
          fi

          # Source type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.source_type }}" ]; then
            echo "source_type=${{ github.event.inputs.source_type }}" >> $GITHUB_OUTPUT
          else
            echo "source_type=PUBSUB" >> $GITHUB_OUTPUT
          fi

      - name: Update manifests
        run: |
          # Update image in JobManager and TaskManager
          FLINK_IMAGE=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

          sed -i "s|image: flink:1.18.1-java17|image: ${FLINK_IMAGE}|g" k8s/gke/flink/flink-jobmanager.yaml
          sed -i "s|image: flink:1.18.1-java17|image: ${FLINK_IMAGE}|g" k8s/gke/flink/flink-taskmanager.yaml
          sed -i "s|image: us-central1-docker.pkg.dev/hsbc-484505/fraud-repo/flink-fraud-detection:latest|image: ${FLINK_IMAGE}|g" k8s/gke/flink/flink-job-submit.yaml

          # Update TaskManager replicas
          sed -i "s|replicas: 2|replicas: ${{ steps.config.outputs.tm_replicas }}|g" k8s/gke/flink/flink-taskmanager.yaml

          # Update source type in job config
          sed -i "s|SOURCE_TYPE: \"PUBSUB\"|SOURCE_TYPE: \"${{ steps.config.outputs.source_type }}\"|g" k8s/gke/flink-job-configmap.yaml

      - name: Create namespace
        run: kubectl apply -f k8s/gke/namespace.yaml

      - name: Deploy Flink Cluster
        run: |
          echo "Deploying Flink cluster components..."

          # Apply ConfigMaps
          kubectl apply -f k8s/gke/flink/flink-configmap.yaml
          kubectl apply -f k8s/gke/flink-job-configmap.yaml

          # Apply Service Account and RBAC
          kubectl apply -f k8s/gke/flink/flink-serviceaccount.yaml

          # Deploy JobManager
          echo "Deploying JobManager..."
          kubectl apply -f k8s/gke/flink/flink-jobmanager.yaml

          # Wait for JobManager to be ready
          kubectl rollout status deployment/flink-jobmanager -n ${{ env.NAMESPACE }} --timeout=180s

          # Deploy TaskManagers
          echo "Deploying TaskManagers..."
          kubectl apply -f k8s/gke/flink/flink-taskmanager.yaml

          # Wait for TaskManagers to be ready
          kubectl rollout status deployment/flink-taskmanager -n ${{ env.NAMESPACE }} --timeout=180s

      - name: Get cluster status
        run: |
          echo "============================================="
          echo "  Flink Cluster Status"
          echo "============================================="
          echo ""
          echo "=== Deployments ==="
          kubectl get deployments -n ${{ env.NAMESPACE }} -l app=flink
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=flink
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ env.NAMESPACE }} -l app=flink
          echo ""

          # Get JobManager Web UI URL
          echo "=== Flink Web UI ==="
          WEBUI_IP=$(kubectl get service flink-jobmanager-webui -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          echo "Web UI URL: http://${WEBUI_IP}:8081"

  # Job 4: Submit Flink Job
  submit-job:
    name: Submit Flink Job
    needs: deploy-cluster
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_cluster_only != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: "gke-gcloud-auth-plugin"

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.PROJECT_ID }}

      - name: Update job submit manifest
        run: |
          FLINK_IMAGE=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          sed -i "s|image: us-central1-docker.pkg.dev/hsbc-484505/fraud-repo/flink-fraud-detection:latest|image: ${FLINK_IMAGE}|g" k8s/gke/flink/flink-job-submit.yaml

      - name: Submit Fraud Detection Job
        run: |
          echo "Submitting Fraud Detection Job..."

          # Delete previous job if exists
          kubectl delete job flink-job-submit -n ${{ env.NAMESPACE }} --ignore-not-found=true

          # Submit new job
          kubectl apply -f k8s/gke/flink/flink-job-submit.yaml

          # Wait for job to complete
          echo "Waiting for job submission to complete..."
          kubectl wait --for=condition=complete job/flink-job-submit -n ${{ env.NAMESPACE }} --timeout=120s || true

          # Show job logs
          echo ""
          echo "=== Job Submission Logs ==="
          kubectl logs job/flink-job-submit -n ${{ env.NAMESPACE }} || true

      - name: Verify running jobs
        run: |
          echo ""
          echo "============================================="
          echo "  Verifying Flink Jobs"
          echo "============================================="

          # Get JobManager pod
          JM_POD=$(kubectl get pods -n ${{ env.NAMESPACE }} -l component=jobmanager -o jsonpath='{.items[0].metadata.name}')

          # Check running jobs via REST API
          echo "=== Running Jobs ==="
          kubectl exec -n ${{ env.NAMESPACE }} ${JM_POD} -- curl -s http://localhost:8081/jobs 2>/dev/null || echo "Could not fetch jobs"
          echo ""

          # Get cluster overview
          echo "=== Cluster Overview ==="
          kubectl exec -n ${{ env.NAMESPACE }} ${JM_POD} -- curl -s http://localhost:8081/overview 2>/dev/null || echo "Could not fetch overview"

      - name: Deployment Summary
        run: |
          echo ""
          echo "============================================="
          echo "  Flink Cluster Deployment Complete!"
          echo "============================================="
          echo ""
          echo "Configuration:"
          echo "  - Project: ${{ env.PROJECT_ID }}"
          echo "  - Cluster: ${{ env.GKE_CLUSTER }}"
          echo "  - Namespace: ${{ env.NAMESPACE }}"
          echo "  - TaskManagers: ${{ github.event.inputs.taskmanager_replicas || '2' }}"
          echo "  - Source Type: ${{ github.event.inputs.source_type || 'PUBSUB' }}"
          echo ""
          echo "Monitoring Commands:"
          echo "  # View Flink Web UI (port-forward)"
          echo "  kubectl port-forward svc/flink-jobmanager 8081:8081 -n ${{ env.NAMESPACE }}"
          echo ""
          echo "  # View JobManager logs"
          echo "  kubectl logs -f deployment/flink-jobmanager -n ${{ env.NAMESPACE }}"
          echo ""
          echo "  # View TaskManager logs"
          echo "  kubectl logs -f deployment/flink-taskmanager -n ${{ env.NAMESPACE }}"
          echo ""
          echo "  # Scale TaskManagers"
          echo "  kubectl scale deployment/flink-taskmanager --replicas=4 -n ${{ env.NAMESPACE }}"
